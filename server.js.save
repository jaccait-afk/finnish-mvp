const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const cors = require('cors');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
const jwt = require('jsonwebtoken');

const app = express();
const PORT = process.env.PORT || 3001;
const JWT_SECRET = 'finnish-mvp-2026-secret';

app.use(helmet());
app.use(cors({ origin: '*' }));
const limiter = rateLimit({ windowMs: 15*60*1000, max: 100 });
app.use(limiter);
app.use(express.json({ limit: '10kb' }));
app.use(express.static('public'));

const db = new sqlite3.Database(':memory:');
db.serialize(() => {
  db.run(`CREATE TABLE users (id INTEGER PRIMARY KEY, knowledge_map TEXT, token TEXT)`);
  db.run(`CREATE TABLE sessions (id INTEGER PRIMARY KEY, user_id INTEGER, concept TEXT, mastery REAL)`);
});

const CASE_QUESTIONS = [
  { sentence: "Menen kotiin.", english: "I go home.", options: ['illative', 'inessive', 'nominative', 'genitive'], correct: 'illative' },
  { sentence: "Kirja on pöydällä.", english: "Book on table.", options: ['adessive', 'ablative', 'illative', 'elative'], correct: 'adessive' },
  { sentence: "Talo on kaupungissa.", english: "House in city.", options: ['inessive', 'illative', 'elative', 'ablative'], correct: 'inessive' },
  { sentence: "Lapsi nukkuu sängyssä.", english: "Child in bed.", options: ['inessive', 'elative', 'illative', 'adessive'], correct: 'inessive' },
  { sentence: "Otan kirjan hyllystä.", english: "Book from shelf.", options: ['elative', 'illative', 'ablative', 'adessive'], correct: 'elative' }
]
const path
app.get('/', (req, res) => res.sendFile(__dirname + '/public/index.html'));
app.post('/api/user', (req, res) => {
  const token = jwt.sign({id: 1}, JWT_SECRET);
  db.run('INSERT OR REPLACE INTO users (id, token) VALUES (1, ?)', [token]);
  res.json({token});
});

app.post('/api/diagnostic', (req, res) => {
  try {
    const { token, answers } = req.body;
    jwt.verify(token, JWT_SECRET);
    
    if (!Array.isArray(answers) || answers.length !== 5) return res.status(400).json({error: 'Invalid'});
    
    let score = 0;
    const mastery = {};
    CASE_QUESTIONS.forEach((q, i) => {
      if (answers[i] === q.correct) score++;
      mastery[q.correct] = mastery[q.correct] || 0;
      mastery[q.correct] += answers[i] === q.correct ? 1 : 0;
    });
    
    const overall = Math.round((score / 5) * 100);
    const result = { overall, cases: mastery, weak: overall < 70 ? ['illative'] : [] };
    
    db.run('UPDATE users SET knowledge_map = ? WHERE id = 1', [JSON.stringify(result)]);
    res.json(result);
  } catch {
    res.status(401).json({error: 'Unauthorized'});
  }
});

app.get('/api/map', (req, res) => res.json({cases: {illative: 35, inessive: 42, adessive: 68, nominative: 95}}));
app.listen(PORT, () => console.log(`Finnish MVP: http://localhost:${PORT}`));

module.exports = app;
